<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notcord Premium</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-sidebar: #020617;
            --bg-chat: #0f172a;
            --accent: #3b82f6;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255,255,255,0.08);
            --mention: rgba(245, 158, 11, 0.15);
            --mention-border: #f59e0b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            background: var(--bg-dark); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden; 
        }

        .app-container { display: grid; grid-template-columns: 260px 1fr 240px; height: 100vh; }

        /* SIDEBAR */
        .sidebar { background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 16px; gap: 20px; }
        .brand { font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 8px; color: var(--accent); }
        
        .profile-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 12px; border-radius: 12px; }
        .profile-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: bold; overflow: hidden; border: 2px solid var(--border); }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-info input { background: transparent; border: none; color: white; font-weight: 600; width: 100px; outline: none; border-bottom: 1px solid transparent; }
        .profile-info input:focus { border-bottom-color: var(--accent); }

        .nav-list { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .nav-item { padding: 8px 12px; border-radius: 8px; cursor: pointer; color: var(--text-muted); transition: 0.2s; font-weight: 500; font-size: 14px; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: rgba(59, 130, 246, 0.1); color: var(--accent); }

        .theme-engine { border-top: 1px solid var(--border); padding-top: 15px; font-size: 12px; }
        .theme-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .theme-row input { width: 40px; height: 20px; border: none; background: transparent; cursor: pointer; }

        /* CHAT AREA */
        .chat-main { background: var(--bg-chat); display: flex; flex-direction: column; position: relative; }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .chat-header h2 { font-size: 16px; }

        .messages-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .msg { display: flex; gap: 12px; max-width: 85%; }
        .msg.me { align-self: flex-end; flex-direction: row-reverse; }
        .msg.mention { background: var(--mention); border-left: 3px solid var(--mention-border); border-radius: 4px; padding: 5px; }
        
        .msg-bubble { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 10px 14px; border-radius: 14px; position: relative; }
        .msg.me .msg-bubble { background: var(--accent); color: white; border: none; }
        .msg-meta { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; font-weight: 700; }
        .msg.me .msg-meta { color: rgba(255,255,255,0.8); }
        .msg-text { font-size: 14px; line-height: 1.5; word-break: break-word; }

        /* SPECIAL CHANNEL CONTENTS */
        .img-content img { max-width: 100%; border-radius: 8px; margin-top: 8px; border: 1px solid var(--border); cursor: zoom-in; }
        .code-content { background: #000; padding: 12px; border-radius: 8px; font-family: 'Fira Code', monospace; font-size: 13px; margin-top: 8px; border: 1px solid var(--border); position: relative; }
        .copy-btn { position: absolute; top: 8px; right: 8px; padding: 4px 8px; border-radius: 4px; background: var(--accent); border: none; color: white; font-size: 10px; cursor: pointer; opacity: 0; transition: 0.2s; }
        .code-content:hover .copy-btn { opacity: 1; }

        /* INPUT */
        .input-area { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 12px; align-items: flex-end; }
        textarea { flex: 1; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 12px; color: white; padding: 12px; outline: none; resize: none; max-height: 150px; font-size: 14px; transition: 0.2s; }
        textarea:focus { border-color: var(--accent); background: rgba(255,255,255,0.05); }
        .btn-send { background: var(--accent); width: 42px; height: 42px; border: none; border-radius: 12px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
        .btn-send:hover { filter: brightness(1.2); transform: scale(1.05); }

        /* ONLINE LIST */
        .online-sidebar { background: var(--bg-sidebar); border-left: 1px solid var(--border); padding: 16px; }
        .section-label { color: var(--text-muted); font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
        .user-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-size: 13px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #4b5563; border: 2px solid var(--bg-sidebar); }
        .user-row.online .status-dot { background: #22c55e; box-shadow: 0 0 10px rgba(34, 197, 94, 0.4); }

        /* MODALS / OVERLAYS */
        .upload-overlay { background: rgba(0,0,0,0.8); position: absolute; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; }
        .upload-card { background: var(--bg-sidebar); padding: 25px; border-radius: 20px; width: 300px; text-align: center; border: 1px solid var(--border); }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="brand">NOTCORD</div>
        
        <div class="profile-card">
            <div class="profile-header">
                <div class="avatar" id="myAvatar">?</div>
                <div class="profile-info">
                    <input type="text" id="myName" placeholder="Set Name..." maxlength="15">
                </div>
            </div>
            <input type="text" id="myAvatarUrl" placeholder="Avatar URL..." style="width:100%;font-size:10px;background:none;border:none;color:var(--text-muted);outline:none;">
        </div>

        <div class="nav-list" id="channelList">
            <div class="nav-item active" data-chan="general"># general</div>
            <div class="nav-item" data-chan="photos"># photos</div>
            <div class="nav-item" data-chan="code"># code</div>
        </div>

        <div class="theme-engine">
            <div class="section-label">THEME ENGINE</div>
            <div class="theme-row">Primary <input type="color" id="colorBase" value="#0f172a"></div>
            <div class="theme-row">Accent <input type="color" id="colorAccent" value="#3b82f6"></div>
        </div>
    </aside>

    <main class="chat-main">
        <div class="chat-header">
            <h2 id="currentChannelName"># general</h2>
            <div id="connectionStatus" style="font-size:10px; color:#22c55e">‚óè Connected</div>
        </div>

        <div class="messages-container" id="msgBox"></div>

        <div class="input-area" id="standardInput">
            <textarea id="msgInput" placeholder="Send a message..." rows="1"></textarea>
            <button class="btn-send" id="sendBtn">‚û§</button>
        </div>

        <div id="imageInputArea" class="input-area" style="display:none">
            <input type="text" id="imgUrlInput" placeholder="Paste image link..." style="flex:1;background:rgba(0,0,0,0.2);border:1px solid var(--border);padding:10px;border-radius:10px;color:white;outline:none">
            <button class="btn-send" id="sendImgBtn">üì∑</button>
        </div>

        <div id="codeInputArea" class="input-area" style="display:none; flex-direction:column">
            <textarea id="codeBodyInput" placeholder="Paste code here..." style="width:100%"></textarea>
            <div style="display:flex; justify-content:space-between; width:100%; margin-top:10px">
                <input type="text" id="codeLangInput" placeholder="Language (js, html...)" style="background:none; border:1px solid var(--border); color:white; padding:5px; border-radius:5px">
                <button class="btn-send" id="sendCodeBtn">Upload Code</button>
            </div>
        </div>
    </main>

    <aside class="online-sidebar">
        <div class="section-label">ONLINE ‚Äî <span id="onlineCount">0</span></div>
        <div id="playersList"></div>
    </aside>
</div>

<script>
    // --- CONFIG & STATE ---
    const MOCK_API = "https://68e839b2f2707e6128ca35e1.mockapi.io";
    const ENDPOINTS = {
        general: `${MOCK_API}/chat`,
        photos: `${MOCK_API}/photos`,
        code: `${MOCK_API}/code`,
        players: `${MOCK_API}/players`
    };

    let currentUser = {
        id: localStorage.getItem('nc_id') || null,
        name: localStorage.getItem('nc_name') || 'Guest' + Math.floor(Math.random()*999),
        avatar: localStorage.getItem('nc_avatar') || ''
    };

    let activeChannel = 'general';
    let lastMsgId = 0;
    let players = [];

    // --- DOM ELEMENTS ---
    const msgBox = document.getElementById('msgBox');
    const msgInput = document.getElementById('msgInput');
    const nameInput = document.getElementById('myName');
    const playersList = document.getElementById('playersList');

    // --- INITIALIZE ---
    function init() {
        nameInput.value = currentUser.name;
        updateAvatar();
        loadTheme();
        requestNotifs();
        
        // Polling
        setInterval(fetchMessages, 2500);
        setInterval(heartbeat, 8000);
        setInterval(fetchPlayers, 6000);
        
        fetchMessages();
        heartbeat();
        fetchPlayers();
    }

    function requestNotifs() {
        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }
    }

    // --- PLAYER & API LOGIC ---
    async function heartbeat() {
        if (!currentUser.name) return;
        const payload = {
            name: currentUser.name,
            avatar: currentUser.avatar,
            lastSeen: Date.now(),
            online: true
        };

        try {
            if (currentUser.id) {
                await fetch(`${ENDPOINTS.players}/${currentUser.id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
            } else {
                const res = await fetch(ENDPOINTS.players, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                currentUser.id = data.id;
                localStorage.setItem('nc_id', data.id);
            }
        } catch(e) { console.error("Heartbeat failed", e); }
    }

    async function fetchPlayers() {
        try {
            const res = await fetch(ENDPOINTS.players);
            players = await res.json();
            const now = Date.now();
            let onlineHtml = '';
            let count = 0;

            players.forEach(p => {
                const isOnline = (now - p.lastSeen) < 25000;
                if(isOnline) count++;
                onlineHtml += `
                    <div class="user-row ${isOnline ? 'online' : ''}">
                        <div class="status-dot"></div>
                        <span>${escapeHtml(p.name)}</span>
                    </div>
                `;
            });
            playersList.innerHTML = onlineHtml || '<div style="font-size:11px;color:var(--text-muted)">Empty</div>';
            document.getElementById('onlineCount').textContent = count;
        } catch(e) {}
    }

    // --- MESSAGE LOGIC ---
    async function fetchMessages() {
        try {
            const res = await fetch(ENDPOINTS[activeChannel]);
            const msgs = await res.json();
            const sorted = msgs.sort((a,b) => a.id - b.id);
            
            if (sorted.length > 0 && sorted[sorted.length-1].id !== lastMsgId) {
                const newMessages = sorted.filter(m => m.id > lastMsgId);
                renderMessages(sorted);
                
                // Mentions & Notifications
                newMessages.forEach(m => {
                    if (m.username !== currentUser.name) {
                        if (m.message && m.message.includes('@' + currentUser.name)) {
                            new Notification("Mentioned in #" + activeChannel, { body: `${m.username}: ${m.message}` });
                        }
                    }
                });
                
                lastMsgId = sorted[sorted.length-1].id;
                scrollToBottom();
            }
        } catch(e) {}
    }

    function renderMessages(msgs) {
        msgBox.innerHTML = msgs.map(m => {
            const isMe = m.username === currentUser.name;
            const isMention = m.message && m.message.includes('@' + currentUser.name);
            
            let content = `<div class="msg-text">${escapeHtml(m.message)}</div>`;
            
            if (activeChannel === 'photos' && m.url) {
                content = `<div class="img-content"><img src="${m.url}" onclick="window.open('${m.url}')"></div>`;
            } else if (activeChannel === 'code' && m.code) {
                content = `
                    <div style="font-size:11px; color:var(--accent)">Language: ${escapeHtml(m.lang)}</div>
                    <div class="code-content">
                        <button class="copy-btn" onclick="navigator.clipboard.writeText(\`${m.code}\`)">Copy</button>
                        <code>${escapeHtml(m.code)}</code>
                    </div>
                `;
            }

            return `
                <div class="msg ${isMe ? 'me' : ''} ${isMention ? 'mention' : ''}">
                    <div class="msg-bubble">
                        <div class="msg-meta">${escapeHtml(m.username)}</div>
                        ${content}
                    </div>
                </div>
            `;
        }).join('');
    }

    async function send(type = 'text', data = {}) {
        let payload = { username: currentUser.name, createdAt: Date.now() };
        
        if (type === 'text') {
            const val = msgInput.value.trim();
            if (!val) return;
            payload.message = val;
            msgInput.value = '';
        } else if (type === 'img') {
            const url = document.getElementById('imgUrlInput').value.trim();
            if (!url) return;
            payload.url = url;
            document.getElementById('imgUrlInput').value = '';
        } else if (type === 'code') {
            const code = document.getElementById('codeBodyInput').value.trim();
            if (!code) return;
            payload.code = code;
            payload.lang = document.getElementById('codeLangInput').value || 'text';
            document.getElementById('codeBodyInput').value = '';
        }

        try {
            await fetch(ENDPOINTS[activeChannel], {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            fetchMessages();
        } catch(e) {}
    }

    // --- HELPERS ---
    function scrollToBottom() {
        const threshold = 150;
        const isNearBottom = (msgBox.scrollHeight - msgBox.scrollTop - msgBox.clientHeight) < threshold;
        if (isNearBottom) {
            msgBox.scrollTop = msgBox.scrollHeight;
        }
    }

    function escapeHtml(str) {
        if(!str) return "";
        return str.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function updateAvatar() {
        const el = document.getElementById('myAvatar');
        if (currentUser.avatar) {
            el.innerHTML = `<img src="${currentUser.avatar}">`;
        } else {
            el.textContent = currentUser.name.charAt(0).toUpperCase();
        }
    }

    // --- UI EVENTS ---
    nameInput.addEventListener('change', () => {
        currentUser.name = nameInput.value || 'Guest';
        localStorage.setItem('nc_name', currentUser.name);
        updateAvatar();
        heartbeat();
    });

    document.getElementById('myAvatarUrl').addEventListener('change', (e) => {
        currentUser.avatar = e.target.value;
        localStorage.setItem('nc_avatar', currentUser.avatar);
        updateAvatar();
        heartbeat();
    });

    document.querySelectorAll('.nav-item').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            activeChannel = btn.dataset.chan;
            document.getElementById('currentChannelName').textContent = '# ' + activeChannel;
            
            document.getElementById('standardInput').style.display = activeChannel === 'general' ? 'flex' : 'none';
            document.getElementById('imageInputArea').style.display = activeChannel === 'photos' ? 'flex' : 'none';
            document.getElementById('codeInputArea').style.display = activeChannel === 'code' ? 'flex' : 'none';
            
            lastMsgId = 0; 
            msgBox.innerHTML = '';
            fetchMessages();
        });
    });

    document.getElementById('sendBtn').onclick = () => send('text');
    document.getElementById('sendImgBtn').onclick = () => send('img');
    document.getElementById('sendCodeBtn').onclick = () => send('code');
    
    msgInput.onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send('text'); }};

    // --- THEME ---
    document.getElementById('colorBase').oninput = (e) => setTheme('--bg-chat', e.target.value);
    document.getElementById('colorAccent').oninput = (e) => setTheme('--accent', e.target.value);

    function setTheme(prop, val) {
        document.documentElement.style.setProperty(prop, val);
        localStorage.setItem('theme_' + prop, val);
    }
    function loadTheme() {
        ['--bg-chat', '--accent'].forEach(p => {
            const saved = localStorage.getItem('theme_' + p);
            if(saved) {
                document.documentElement.style.setProperty(p, saved);
                if(p === '--bg-chat') document.getElementById('colorBase').value = saved;
                if(p === '--accent') document.getElementById('colorAccent').value = saved;
            }
        });
    }

    init();
</script>
</body>
</html>

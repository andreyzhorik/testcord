<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>notcord â€” Premium Chat</title>
  <style>
    :root {
      --theme-1: #0f172a;
      --theme-2: #020617;
      --theme-3: #1e293b;
      --muted: #94a3b8;
      --accent: #3b82f6;
      --border: rgba(255,255,255,0.06);
      --text: #f8fafc;
      --online: #22c55e;
      --bubble-bg: #1e293b;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: 'Inter', system-ui, -apple-system, sans-serif; color: var(--text); background: var(--theme-2); -webkit-font-smoothing: antialiased; }
    
    .app { width: 100%; height: 100vh; display: grid; grid-template-columns: 240px 1fr 240px; overflow: hidden; background: var(--theme-2); }
    
    /* Sidebar Compact */
    .sidebar { padding: 12px; display: flex; flex-direction: column; gap: 10px; background: var(--theme-1); border-right: 1px solid var(--border); }
    .brand { display: flex; gap: 8px; align-items: center; font-weight: 800; font-size: 16px; margin-bottom: 4px; }
    .brand .dot { width: 24px; height: 24px; border-radius: 6px; background: var(--accent); display: flex; align-items: center; justify-content: center; color: white; }
    
    .usernameBox { display: flex; gap: 6px; align-items: center; }
    .usernameBox input { flex: 1; padding: 6px 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 6px; color: inherit; outline: none; font-size: 13px; }
    .usernameBox button { padding: 6px 10px; border-radius: 6px; border: none; background: var(--accent); color: white; cursor: pointer; font-size: 13px; font-weight: 600; }
    
    .usernameLocked { display: flex; gap: 8px; align-items: center; padding: 6px; border-radius: 8px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); font-size: 13px; }
    .usernameLocked .avatar { width: 32px; height: 32px; border-radius: 50%; overflow: hidden; background: rgba(255,255,255,0.05); }
    
    .channels { display: flex; flex-direction: column; gap: 2px; }
    .channel { padding: 6px 10px; border-radius: 6px; color: var(--muted); cursor: pointer; font-size: 14px; font-weight: 500; transition: 0.1s; }
    .channel:hover { background: rgba(255,255,255,0.03); color: var(--text); }
    .channel.active { background: rgba(59, 130, 246, 0.1); color: var(--accent); }

    /* Chat Panel */
    .chatPanel { display: flex; flex-direction: column; min-height: 0; background: var(--theme-2); }
    .header { padding: 10px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .header h2 { margin: 0; font-size: 15px; font-weight: 700; }
    .status { color: var(--muted); font-size: 12px; }
    
    .messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
    .message { display: flex; gap: 10px; align-items: flex-start; max-width: 90%; }
    .message.me { margin-left: auto; flex-direction: row-reverse; }
    
    .bubble { background: var(--bubble-bg); padding: 8px 12px; border-radius: 12px; border: 1px solid var(--border); position: relative; }
    .message.me .bubble { border-color: rgba(59, 130, 246, 0.3); }
    
    .meta { display: flex; gap: 6px; font-size: 11px; margin-bottom: 2px; color: var(--muted); }
    .meta .name { font-weight: 700; }
    .text { font-size: 14px; line-height: 1.4; word-break: break-word; white-space: pre-wrap; }
    
    /* Code/Image specifics */
    .code-block { background: #000; border-radius: 6px; padding: 10px; margin-top: 6px; font-family: monospace; font-size: 13px; position: relative; overflow-x: auto; }
    .copy-btn { position: absolute; top: 5px; right: 5px; font-size: 10px; background: var(--accent); border: none; color: white; border-radius: 4px; cursor: pointer; padding: 2px 6px; }
    .photoMessage img { max-width: 100%; border-radius: 8px; margin-top: 4px; cursor: pointer; }

    /* Input Area */
    .inputArea { padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
    textarea { flex: 1; min-height: 38px; max-height: 120px; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); color: #fff; outline: none; resize: none; font-size: 14px; }
    .sendBtn { background: var(--accent); border: none; color: white; padding: 0 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; }
    .sendBtn:disabled { opacity: 0.4; }

    /* Online Players sidebar */
    .playersPanel { padding: 12px; background: var(--theme-1); border-left: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
    .playersPanel h3 { font-size: 13px; margin: 0; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .player { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-size: 13px; }
    .statusDot { width: 8px; height: 8px; border-radius: 50%; background: #4b5563; }
    .online .statusDot { background: var(--online); box-shadow: 0 0 6px var(--online); }
    
    /* Pinned message */
    .pinnedCenter { position: absolute; top: 50px; left: 50%; transform: translateX(-50%); background: var(--accent); color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

    /* Settings scrollable */
    .settings { margin-top: auto; padding-top: 10px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; font-size: 12px; }
    .settings label { color: var(--muted); display: flex; flex-direction: column; gap: 4px; }
    input[type="color"] { width: 100%; height: 24px; border: none; background: transparent; cursor: pointer; }
    .toggleBtn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text); padding: 4px; border-radius: 4px; cursor: pointer; font-size: 11px; }

    @media (max-width: 800px) { .app { grid-template-columns: 1fr; } .sidebar, .playersPanel { display: none; } }
  </style>
</head>
<body>

  <div class="app">
    <aside class="sidebar">
      <div class="brand"><div class="dot">N</div><div class="name">notcord</div></div>
      <div id="usernameSection">
        <div class="usernameBox" id="usernameBox">
          <input type="text" id="usernameInput" placeholder="User..." maxlength="8" />
          <button id="setNameBtn">Set</button>
        </div>
        <div class="usernameLocked" id="usernameLocked" style="display:none">
          <div class="avatar" id="avatarDisplay"></div>
          <div style="flex:1"><div id="usernameDisplay"></div></div>
          <button id="changeNameBtn" class="toggleBtn">Edit</button>
        </div>
      </div>
      <div class="channels" id="channels">
        <div class="channel active" data-id="general"># general</div>
        <div class="channel" data-id="photos"># photos</div>
        <div class="channel" data-id="code"># code</div>
      </div>
      <div class="settings">
        <label>Theme <input type="color" id="themeColor1"></label>
        <label>Accent <input type="color" id="accentColor"></label>
        <button id="toggleNotifs" class="toggleBtn">Enable Notifications</button>
      </div>
    </aside>

    <section class="chatPanel">
      <div class="header">
        <h2 id="channelTitle"># general</h2>
        <div id="status" class="status">Connecting...</div>
      </div>
      <div id="pinnedCenter" class="pinnedCenter" style="display:none"></div>
      <div class="messages" id="messages"></div>
      
      <div class="inputArea" id="inputWrapper">
        <textarea id="messageInput" placeholder="Message..." maxlength="2000"></textarea>
        <button id="sendBtn" class="sendBtn" disabled>Send</button>
      </div>

      <div class="photoUploadArea inputArea" id="photoUploadWrapper" style="display:none">
        <input type="file" id="photoInput" accept="image/*" />
        <button id="uploadPhotoBtn" class="sendBtn">Upload</button>
      </div>

      <div class="codeUploadArea inputArea" id="codeUploadWrapper" style="display:none; flex-direction:column">
        <textarea id="codeInput" placeholder="Paste code..."></textarea>
        <div style="display:flex; gap:5px; margin-top:5px">
            <input type="text" id="languageInput" placeholder="lang..." style="padding:4px; border-radius:4px; border:1px solid var(--border); background:rgba(0,0,0,0.2); color:white">
            <button id="uploadCodeBtn" class="sendBtn">Upload Code</button>
        </div>
      </div>
    </section>

    <aside class="playersPanel">
      <h3>Online</h3>
      <div id="playersList"></div>
    </aside>
  </div>

  <script>
    (function(){
      const CHANNELS = {
        general: 'https://68e839b2f2707e6128ca35e1.mockapi.io/chat',
        photos: 'https://68eeed86b06cc802829ba196.mockapi.io/photos',
        code: 'https://68eeed86b06cc802829ba196.mockapi.io/code'
      };
      const PLAYERS_API = 'https://68e839b2f2707e6128ca35e1.mockapi.io/players';
      
      let username = localStorage.getItem('notcord_username') || '';
      let activeChannel = 'general';
      let localPlayerId = localStorage.getItem('notcord_playerId') || null;
      let lastMessageCount = 0;

      const messagesEl = document.getElementById('messages');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const playersListEl = document.getElementById('playersList');

      // --- SMART SCROLL ---
      function scrollToBottom(force = false) {
        const threshold = 100;
        const isNearBottom = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight < threshold;
        if (force || isNearBottom) {
          messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' });
        }
      }

      // --- NOTIFICATIONS ---
      document.getElementById('toggleNotifs').addEventListener('click', () => {
        Notification.requestPermission();
      });

      function notify(title, body) {
        if (Notification.permission === 'granted' && document.hidden) {
          new Notification(title, { body });
        }
      }

      // --- PLAYER UPDATES (NO DUPLICATES) ---
      async function syncPlayer() {
        if (!username) return;
        const payload = { 
            name: username, 
            lastSeen: new Date().toISOString(), 
            online: true,
            avatarUrl: localStorage.getItem('notcord_avatar') 
        };
        
        try {
          if (localPlayerId) {
            const res = await fetch(`${PLAYERS_API}/${localPlayerId}`, {
              method: 'PUT',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(payload)
            });
            if (!res.ok) localPlayerId = null; // Reset if ID expired
          }
          
          if (!localPlayerId) {
            const res = await fetch(PLAYERS_API, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            localPlayerId = data.id;
            localStorage.setItem('notcord_playerId', data.id);
          }
        } catch(e) {}
      }

      // --- MESSAGE RENDERING ---
      async function fetchMessages() {
        try {
          const res = await fetch(CHANNELS[activeChannel]);
          const msgs = await res.json();
          const sorted = msgs.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
          
          // Only re-render if count changed
          if (sorted.length !== lastMessageCount) {
            const newMsg = sorted[sorted.length - 1];
            if (lastMessageCount > 0 && newMsg.username !== username) {
                notify(`${newMsg.username} says:`, newMsg.message || "New message");
            }
            renderMessages(sorted);
            lastMessageCount = sorted.length;
          }
        } catch(e) {}
      }

      function renderMessages(msgs) {
        messagesEl.innerHTML = msgs.map(m => {
          const isMe = m.username === username;
          let content = `<div class="text">${escapeHtml(m.message)}</div>`;
          
          if (activeChannel === 'photos' && m.imageUrl) {
            content = `<div class="photoMessage"><img src="${m.imageUrl}" onclick="window.open('${m.imageUrl}')"></div>`;
          } else if (activeChannel === 'code' && m.code) {
            content = `<div class="code-block"><button class="copy-btn" onclick="navigator.clipboard.writeText(\`${m.code}\`)">Copy</button><code>${escapeHtml(m.code)}</code></div>`;
          }

          return `
            <div class="message ${isMe ? 'me' : ''}">
              <div class="bubble">
                <div class="meta"><span class="name">${escapeHtml(m.username)}</span></div>
                ${content}
              </div>
            </div>
          `;
        }).join('');
        scrollToBottom();
      }

      async function postMessage() {
        const text = messageInput.value.trim();
        if (!text || !username) return;
        
        messageInput.value = '';
        sendBtn.disabled = true;

        try {
          await fetch(CHANNELS[activeChannel], {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                username, 
                message: text, 
                createdAt: new Date().toISOString()
            })
          });
          fetchMessages();
        } catch(e) {}
        sendBtn.disabled = false;
      }

      // --- PLAYER LIST ---
      async function fetchPlayers() {
        try {
          const res = await fetch(PLAYERS_API);
          const players = await res.json();
          const now = Date.now();
          playersListEl.innerHTML = players.map(p => {
             const isOnline = (now - new Date(p.lastSeen).getTime()) < 20000;
             return `<div class="player ${isOnline ? 'online' : ''}"><div class="statusDot"></div><span>${escapeHtml(p.name)}</span></div>`;
          }).join('');
        } catch(e) {}
      }

      function escapeHtml(s) { return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

      // --- UI EVENTS ---
      document.getElementById('setNameBtn').addEventListener('click', () => {
        const val = document.getElementById('usernameInput').value.trim();
        if (val) {
          username = val;
          localStorage.setItem('notcord_username', username);
          document.getElementById('usernameBox').style.display = 'none';
          document.getElementById('usernameLocked').style.display = 'flex';
          document.getElementById('usernameDisplay').textContent = username;
          syncPlayer();
        }
      });

      document.getElementById('changeNameBtn').addEventListener('click', () => {
        document.getElementById('usernameBox').style.display = 'flex';
        document.getElementById('usernameLocked').style.display = 'none';
      });

      messageInput.addEventListener('input', () => {
        sendBtn.disabled = !messageInput.value.trim();
      });

      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          postMessage();
        }
      });

      sendBtn.addEventListener('click', postMessage);

      document.querySelectorAll('.channel').forEach(ch => {
        ch.addEventListener('click', () => {
          document.querySelectorAll('.channel').forEach(c => c.classList.remove('active'));
          ch.classList.add('active');
          activeChannel = ch.dataset.id;
          document.getElementById('channelTitle').textContent = '# ' + activeChannel;
          
          // Toggle input types
          document.getElementById('inputWrapper').style.display = activeChannel === 'general' ? 'flex' : 'none';
          document.getElementById('photoUploadWrapper').style.display = activeChannel === 'photos' ? 'flex' : 'none';
          document.getElementById('codeUploadWrapper').style.display = activeChannel === 'code' ? 'flex' : 'none';
          
          lastMessageCount = 0;
          fetchMessages();
        });
      });

      // Init
      if (username) {
        document.getElementById('usernameBox').style.display = 'none';
        document.getElementById('usernameLocked').style.display = 'flex';
        document.getElementById('usernameDisplay').textContent = username;
      }
      
      setInterval(fetchMessages, 3000);
      setInterval(fetchPlayers, 5000);
      setInterval(syncPlayer, 10000); // Heartbeat
      fetchMessages();
      fetchPlayers();
      syncPlayer();

    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notcord Premium</title>
    <style>
        :root {
            --bg-sidebar: #020617; --bg-chat: #0f172a; --accent: #3b82f6;
            --text-main: #f8fafc; --text-muted: #94a3b8; --border: rgba(255,255,255,0.08);
            --mention: rgba(245, 158, 11, 0.15); --mention-border: #f59e0b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-chat); color: var(--text-main); height: 100vh; overflow: hidden; }
        .app-container { display: grid; grid-template-columns: 260px 1fr 240px; height: 100vh; }

        /* SIDEBAR */
        .sidebar { background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 12px; gap: 15px; }
        .brand { font-size: 16px; font-weight: 900; color: var(--accent); letter-spacing: 2px; padding: 10px; }
        .profile-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 10px; border-radius: 12px; }
        .profile-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .avatar-box { width: 42px; height: 42px; border-radius: 50%; background: var(--accent); position: relative; cursor: pointer; border: 2px solid var(--border); flex-shrink: 0; overflow: hidden; }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-box:hover::after { content: 'UP'; position: absolute; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .profile-info input { background: transparent; border: none; color: white; font-weight: 700; width: 100%; outline: none; font-size: 14px; }
        
        .nav-list { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .nav-item { padding: 8px 12px; border-radius: 6px; cursor: pointer; color: var(--text-muted); font-size: 14px; transition: 0.1s; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.04); color: white; }
        .nav-item.active { color: var(--accent); background: rgba(59, 130, 246, 0.1); }

        /* CHAT AREA */
        .chat-main { display: flex; flex-direction: column; background: var(--bg-chat); position: relative; }
        .chat-header { padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .messages-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { display: flex; gap: 12px; max-width: 80%; }
        .msg.me { align-self: flex-end; flex-direction: row-reverse; }
        .msg-avatar { width: 36px; height: 36px; border-radius: 50%; background: #334155; flex-shrink: 0; overflow: hidden; border: 1px solid var(--border); }
        .msg-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .msg-bubble { background: rgba(255,255,255,0.04); padding: 8px 12px; border-radius: 12px; border: 1px solid var(--border); }
        .msg.me .msg-bubble { background: var(--accent); border: none; color: white; }
        .msg-user { font-size: 11px; font-weight: 800; margin-bottom: 2px; color: var(--text-muted); }
        .msg.me .msg-user { display: none; }
        .msg-text { font-size: 14px; line-height: 1.4; word-break: break-word; }

        /* INPUTS */
        .input-area { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: flex-end; }
        textarea, .link-input { flex: 1; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; color: white; padding: 10px; outline: none; resize: none; font-size: 14px; }
        .upload-btn { background: #334155; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-send { background: var(--accent); border: none; padding: 0 15px; height: 40px; border-radius: 10px; color: white; cursor: pointer; font-weight: 700; }

        .online-sidebar { background: var(--bg-sidebar); border-left: 1px solid var(--border); padding: 15px; }
        .user-row { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-size: 13px; opacity: 0.7; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #4b5563; }
        .user-row.online { opacity: 1; }
        .user-row.online .status-dot { background: #22c55e; box-shadow: 0 0 8px #22c55e; }

        .image-preview { max-width: 100%; border-radius: 8px; margin-top: 5px; cursor: pointer; border: 1px solid var(--border); }
        .code-block { background: #000; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 12px; margin-top: 5px; position: relative; }
        .copy-btn { position: absolute; top: 5px; right: 5px; font-size: 9px; padding: 3px; background: var(--accent); border: none; color: white; border-radius: 3px; opacity: 0.6; cursor: pointer; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="brand">NOTCORD</div>
        <div class="profile-card">
            <div class="profile-header">
                <div class="avatar-box" id="avatarTrigger">
                    <img id="myAvatarImg" src="">
                    <input type="file" id="avatarFile" hidden accept="image/*">
                </div>
                <div class="profile-info">
                    <input type="text" id="myName" placeholder="Set Username..." maxlength="12">
                </div>
            </div>
            <input type="text" id="myAvatarUrl" class="link-input" style="font-size:10px; padding:5px" placeholder="Paste Avatar Link...">
        </div>
        <nav class="nav-list" id="chanList">
            <div class="nav-item active" data-id="general"># general</div>
            <div class="nav-item" data-id="photos"># photos</div>
            <div class="nav-item" data-id="code"># code</div>
        </nav>
        <div style="font-size:11px; color:var(--text-muted); margin-top:auto">
            <p>Theme: <input type="color" id="baseColor" value="#0f172a"></p>
            <p>Accent: <input type="color" id="accentColor" value="#3b82f6"></p>
        </div>
    </aside>

    <main class="chat-main">
        <div class="chat-header"><h2 id="chanTitle"># general</h2><small id="status" style="color:#22c55e">‚óè Online</small></div>
        <div class="messages-container" id="msgContainer"></div>

        <!-- Inputs per channel -->
        <div id="ui-general" class="input-area">
            <textarea id="msgInput" placeholder="Message #general..." rows="1"></textarea>
            <button class="btn-send" id="sendBtn">Send</button>
        </div>

        <div id="ui-photos" class="input-area" style="display:none">
            <button class="upload-btn" id="photoFileBtn">üìÅ</button>
            <input type="file" id="photoFile" hidden accept="image/*">
            <input type="text" id="photoUrl" class="link-input" placeholder="Paste image link here...">
            <button class="btn-send" id="sendPhoto">Post</button>
        </div>

        <div id="ui-code" class="input-area" style="display:none; flex-direction:column">
            <textarea id="codeBody" placeholder="Paste code snippets here..." rows="3" style="width:100%"></textarea>
            <div style="display:flex; width:100%; gap:10px; margin-top:5px">
                <input type="text" id="codeLang" class="link-input" placeholder="Language (e.g. js, python)">
                <button class="btn-send" id="sendCode">Upload Code</button>
            </div>
        </div>
    </main>

    <aside class="online-sidebar">
        <div style="font-size:11px; font-weight:900; color:var(--text-muted); margin-bottom:15px">ONLINE ‚Äî <span id="count">0</span></div>
        <div id="uList"></div>
    </aside>
</div>

<script>
    const API = {
        general: 'https://68e839b2f2707e6128ca35e1.mockapi.io/chat',
        photos: 'https://68eeed86b06cc802829ba196.mockapi.io/photos',
        code: 'https://68eeed86b06cc802829ba196.mockapi.io/code',
        players: 'https://68e839b2f2707e6128ca35e1.mockapi.io/players'
    };

    let user = {
        id: localStorage.getItem('nc_id') || null,
        name: localStorage.getItem('nc_user') || 'User' + Math.floor(Math.random()*999),
        avatar: localStorage.getItem('nc_av') || 'https://api.dicebear.com/7.x/bottts/svg?seed=NC'
    };

    let chan = 'general';
    let maxId = 0;
    let isInitialLoad = true;

    // --- SETUP ---
    function init() {
        document.getElementById('myName').value = user.name;
        document.getElementById('myAvatarImg').src = user.avatar;
        Notification.requestPermission();
        loadTheme();
        
        setInterval(refresh, 2500);
        setInterval(syncUser, 10000);
        refresh();
        syncUser();
    }

    async function refresh() {
        try {
            const res = await fetch(API[chan]);
            const data = await res.json();
            const sorted = data.sort((a,b) => a.id - b.id);
            
            if (sorted.length > 0 && sorted[sorted.length-1].id !== maxId) {
                const newMsgs = sorted.filter(m => parseInt(m.id) > maxId);
                render(sorted);
                
                if (!isInitialLoad) {
                    newMsgs.forEach(m => {
                        if (m.username !== user.name) {
                            if (m.message && m.message.includes('@' + user.name)) {
                                new Notification(`Mentioned by ${m.username}`, { body: m.message });
                            } else if (chan !== 'general') {
                                new Notification(`New post in #${chan}`, { body: `${m.username} shared something.`});
                            }
                        }
                    });
                }
                
                maxId = parseInt(sorted[sorted.length-1].id);
                scroll(isInitialLoad);
                isInitialLoad = false;
            }
            fetchPlayers();
        } catch(e) {}
    }

    function render(data) {
        const box = document.getElementById('msgContainer');
        box.innerHTML = data.map(m => {
            const me = m.username === user.name;
            const mention = m.message && m.message.includes('@' + user.name);
            let body = `<div class="msg-text">${esc(m.message)}</div>`;
            
            if (chan === 'photos' && m.url) body = `<img src="${m.url}" class="image-preview" onclick="window.open('${m.url}')">`;
            if (chan === 'code' && m.code) body = `<div class="code-block"><button class="copy-btn" onclick="navigator.clipboard.writeText(\`${m.code}\`)">Copy</button><code>${esc(m.code)}</code></div>`;

            return `
                <div class="msg ${me ? 'me' : ''}" style="${mention ? 'background:rgba(255,165,0,0.1); border-left:3px solid orange; padding:5px' : ''}">
                    <div class="msg-avatar"><img src="${m.avatar || 'https://api.dicebear.com/7.x/identicon/svg'}"></div>
                    <div class="msg-bubble">
                        <div class="msg-user">${esc(m.username)}</div>
                        ${body}
                    </div>
                </div>`;
        }).join('');
    }

    async function send(type) {
        let payload = { username: user.name, avatar: user.avatar, createdAt: Date.now() };
        if (type === 'text') {
            const val = document.getElementById('msgInput').value.trim();
            if (!val) return;
            payload.message = val;
            document.getElementById('msgInput').value = '';
        } else if (type === 'photo') {
            const val = document.getElementById('photoUrl').value.trim();
            if (!val) return;
            payload.url = val;
            document.getElementById('photoUrl').value = '';
        } else if (type === 'code') {
            const b = document.getElementById('codeBody').value.trim();
            if (!b) return;
            payload.code = b;
            payload.lang = document.getElementById('codeLang').value || 'txt';
            document.getElementById('codeBody').value = '';
        }

        await fetch(API[chan], {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        refresh();
    }

    // --- UTILS ---
    async function syncUser() {
        const payload = { name: user.name, avatar: user.avatar, lastSeen: Date.now(), online: true };
        const res = await fetch(user.id ? `${API.players}/${user.id}` : API.players, {
            method: user.id ? 'PUT' : 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!user.id) { user.id = data.id; localStorage.setItem('nc_id', data.id); }
    }

    async function fetchPlayers() {
        const res = await fetch(API.players);
        const pts = await res.json();
        const now = Date.now();
        let html = '', count = 0;
        pts.forEach(p => {
            const on = (now - p.lastSeen) < 30000;
            if (on) count++;
            html += `<div class="user-row ${on ? 'online' : ''}"><div class="status-dot"></div>${esc(p.name)}</div>`;
        });
        document.getElementById('uList').innerHTML = html;
        document.getElementById('count').innerText = count;
    }

    function scroll(force) {
        const c = document.getElementById('msgContainer');
        const nearBottom = (c.scrollHeight - c.scrollTop - c.clientHeight) < 150;
        if (force || nearBottom) c.scrollTop = c.scrollHeight;
    }

    function esc(s) { return s ? s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }

    // --- EVENTS ---
    document.getElementById('sendBtn').onclick = () => send('text');
    document.getElementById('sendPhoto').onclick = () => send('photo');
    document.getElementById('sendCode').onclick = () => send('code');
    document.getElementById('msgInput').onkeydown = e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send('text'); }};

    document.querySelectorAll('.nav-item').forEach(el => {
        el.onclick = () => {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            chan = el.dataset.id;
            document.getElementById('chanTitle').innerText = '# ' + chan;
            ['general', 'photos', 'code'].forEach(id => document.getElementById('ui-'+id).style.display = chan === id ? 'flex' : 'none');
            maxId = 0; isInitialLoad = true; refresh();
        };
    });

    // Upload & Avatar Logic
    const reader = (file, cb) => { const r = new FileReader(); r.onload = e => cb(e.target.result); r.readAsDataURL(file); };
    document.getElementById('avatarTrigger').onclick = () => document.getElementById('avatarFile').click();
    document.getElementById('avatarFile').onchange = e => reader(e.target.files[0], base => { user.avatar = base; document.getElementById('myAvatarImg').src = base; localStorage.setItem('nc_av', base); syncUser(); });
    document.getElementById('myAvatarUrl').onchange = e => { user.avatar = e.target.value; document.getElementById('myAvatarImg').src = user.avatar; localStorage.setItem('nc_av', user.avatar); syncUser(); };
    document.getElementById('myName').onchange = e => { user.name = e.target.value; localStorage.setItem('nc_user', user.name); syncUser(); };
    
    document.getElementById('photoFileBtn').onclick = () => document.getElementById('photoFile').click();
    document.getElementById('photoFile').onchange = e => reader(e.target.files[0], base => { document.getElementById('photoUrl').value = base; });

    // Themes
    document.getElementById('baseColor').oninput = e => { document.documentElement.style.setProperty('--bg-chat', e.target.value); localStorage.setItem('th_base', e.target.value); };
    document.getElementById('accentColor').oninput = e => { document.documentElement.style.setProperty('--accent', e.target.value); localStorage.setItem('th_acc', e.target.value); };
    function loadTheme() {
        const b = localStorage.getItem('th_base'), a = localStorage.getItem('th_acc');
        if(b) { document.documentElement.style.setProperty('--bg-chat', b); document.getElementById('baseColor').value = b; }
        if(a) { document.documentElement.style.setProperty('--accent', a); document.getElementById('accentColor').value = a; }
    }

    init();
</script>
</body>
</html>
